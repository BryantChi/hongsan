{
    "sourceFile": "resources/views/admin/products_infos/fields.blade.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 6,
            "patches": [
                {
                    "date": 1753257400915,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1753264036915,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -226,8 +226,13 @@\n         }, 5000); // 5秒後自動關閉\n \n         $(function() {\n \n+            $('#product_categories_id').select2({\n+                placeholder: '請先選擇應用類別',\n+                allowClear: true\n+            });\n+\n             // prod_img_cover 檔案選擇器\n             $('#prod_img_cover').on('change', function() {\n                 // 檢查是否選擇了檔案\n                 if (this.files.length === 0) {\n"
                },
                {
                    "date": 1753264065258,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -21,9 +21,9 @@\n \n <!-- Product Categories Id Field -->\n <div class=\"form-group col-sm-4\">\n     {!! Form::label('product_categories_id', '產品類別:') !!}\n-    {!! Form::select('product_categories_id', [], null, ['class' => 'form-control', 'placeholder' => '請先選擇應用類別', 'id' => 'product_categories_id', 'multiple', 'required' => true]) !!}\n+    {!! Form::select('product_categories_id', [], null, ['class' => 'form-control', 'id' => 'product_categories_id', 'placeholder' => '請先選擇應用類別', 'id' => 'product_categories_id', 'multiple', 'required' => true]) !!}\n </div>\n \n <!-- Version Field -->\n <div class=\"form-group col-sm-4\">\n"
                },
                {
                    "date": 1753264600462,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -21,9 +21,9 @@\n \n <!-- Product Categories Id Field -->\n <div class=\"form-group col-sm-4\">\n     {!! Form::label('product_categories_id', '產品類別:') !!}\n-    {!! Form::select('product_categories_id', [], null, ['class' => 'form-control', 'id' => 'product_categories_id', 'placeholder' => '請先選擇應用類別', 'id' => 'product_categories_id', 'multiple', 'required' => true]) !!}\n+    {!! Form::select('product_categories_id', [], null, ['class' => 'form-control', 'id' => 'product_categories_id', 'placeholder' => '請先選擇應用類別', 'multiple', 'required' => true]) !!}\n </div>\n \n <!-- Version Field -->\n <div class=\"form-group col-sm-4\">\n"
                },
                {
                    "date": 1753265043612,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -510,9 +510,11 @@\n \n \n             // 儲存當前產品的品牌和產品類別ID (如果是編輯頁面)\n             var currentBrandId = {{ isset($productsInfo) && $productsInfo->brands_info_id ? $productsInfo->brands_info_id : 'null' }};\n-            var currentProductCategoryId = {{ isset($productsInfo) && $productsInfo->product_categories_id ? $productsInfo->product_categories_id : 'null' }};\n+            var currentProductCategoryIds = @if(isset($productsInfo) && $productsInfo->productCategories)\n+                               {!! json_encode($productsInfo->productCategories->pluck('id')->toArray()) !!}\n+                               @else [] @endif;\n             $('#purchase_lease_container').hide();\n             // 應用類別選擇變更事件\n             $('#application_categories_info_id').on('change', function() {\n                 var applicationCategoryId = $(this).val();\n@@ -565,11 +567,13 @@\n                                     $('<option></option>').val(id).text(name)\n                                 );\n                             });\n \n-                            // 如果是編輯頁面，選中原有的產品類別\n-                            if (currentProductCategoryId) {\n-                                $('#product_categories_id').val(currentProductCategoryId);\n+                            // 如果是編輯頁面，選中原有的產品類別(使用正確的變數名稱)\n+                            if (currentProductCategoryIds && currentProductCategoryIds.length > 0) {\n+                                $('#product_categories_id').val(currentProductCategoryIds);\n+                                // 觸發change事件以更新Select2顯示\n+                                $('#product_categories_id').trigger('change');\n                             }\n                         }\n                     },\n                     error: function(xhr, status, error) {\n"
                },
                {
                    "date": 1753266062224,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,613 @@\n+<!-- Application Categories Info Id Field -->\n+<div class=\"form-group col-sm-6\">\n+    {!! Form::label('application_categories_info_id', '應用類別:', ['class' => 'control-label', 'style' => 'font-weight:bold !important;']) !!}\n+    {!! Form::select('application_categories_info_id', $applicationCategoriesInfos, isset($productCategoriesInfo) ? $productCategoriesInfo->application_categories_info_id : null, ['class' => 'form-control', 'id' => 'application_categories_info_id', 'placeholder' => '請選擇', 'required' => true]) !!}\n+    {{-- <small>※請選擇應用類別</small> --}}\n+</div>\n+<div class=\"clearfix w-100\"></div>\n+\n+<!-- Purchase_Lease Field -->\n+<div class=\"form-group col-sm-6\" id=\"purchase_lease_container\">\n+    {!! Form::label('purchase_lease', '產品購買/租賃:') !!}\n+    {!! Form::select('purchase_lease', ['' => '請選擇', 'purchase' => '購買', 'lease' => '租賃'], null, ['class' => 'form-control', 'id' => 'purchase_lease', 'placeholder' => '請選擇產品購買/租賃方式', 'required' => true]) !!}\n+</div>\n+<div class=\"clearfix w-100\"></div>\n+\n+<!-- Brands Info Id Field -->\n+<div class=\"form-group col-sm-4\">\n+    {!! Form::label('brands_info_id', '產品品牌:') !!}\n+    {!! Form::select('brands_info_id', [], null, ['class' => 'form-control', 'placeholder' => '請先選擇應用類別', 'id' => 'brands_info_id', 'required' => true]) !!}\n+</div>\n+\n+<!-- Product Categories Id Field -->\n+<div class=\"form-group col-sm-4\">\n+    {!! Form::label('product_categories_id', '產品類別:') !!}\n+    {!! Form::select('product_categories_id', [], null, ['class' => 'form-control', 'id' => 'product_categories_id', 'placeholder' => '請先選擇應用類別', 'multiple', 'required' => true]) !!}\n+</div>\n+\n+<!-- Version Field -->\n+<div class=\"form-group col-sm-4\">\n+    {!! Form::label('version', '產品型號(機型版本):') !!}\n+    {!! Form::text('version', null, ['class' => 'form-control']) !!}\n+</div>\n+<div class=\"clearfix w-100\"></div>\n+\n+<!-- 'bootstrap / Toggle Switch Quick Bucket Changer Field' -->\n+<div class=\"form-group col-sm-6\">\n+    <div class=\"custom-control custom-switch\">\n+        {!! Form::checkbox('quick_bucket_changer', 1, null,  ['class' => 'custom-control-input', 'id' => 'quick_bucket_changer']) !!}\n+        {!! Form::label('quick_bucket_changer', '快速換斗器', ['class' => 'custom-control-label']) !!}\n+    </div>\n+</div>\n+<div class=\"clearfix w-100\"></div>\n+\n+<!-- 'bootstrap / Toggle Switch Operating Converter Field' -->\n+<div class=\"form-group col-sm-6\">\n+    <div class=\"custom-control custom-switch\">\n+        {!! Form::checkbox('operating_converter', 1, null,  ['class' => 'custom-control-input', 'id' => 'operating_converter']) !!}\n+        {!! Form::label('operating_converter', '操作轉換器', ['class' => 'custom-control-label']) !!}\n+    </div>\n+</div>\n+<div class=\"clearfix w-100\"></div>\n+\n+<!-- 多語系欄位 -->\n+<div class=\"card col-sm-12\">\n+    <div class=\"card-header\">\n+        <ul class=\"nav nav-tabs card-header-tabs\" role=\"tablist\">\n+            @foreach(config('translatable.locales') as $locale)\n+                <li class=\"nav-item\">\n+                    <a class=\"nav-link {{ $loop->first ? 'active' : '' }}\" data-toggle=\"tab\" href=\"#{{ $locale }}\" role=\"tab\">\n+                        {{ strtoupper($locale) === 'ZH_TW' ? '中文' : 'English' }} 語系\n+                    </a>\n+                </li>\n+            @endforeach\n+        </ul>\n+    </div>\n+    <div class=\"card-body\">\n+        <div class=\"tab-content\">\n+            @foreach(config('translatable.locales') as $locale)\n+                <div class=\"tab-pane {{ $loop->first ? 'active' : '' }}\" id=\"{{ $locale }}\" role=\"tabpanel\">\n+\n+                    <!-- Name Field -->\n+                    <div class=\"form-group col-sm-6\">\n+                        {!! Form::label($locale.'[name]', '產品名稱('.strtoupper($locale).'):') !!}\n+                        {!! Form::text($locale.'[name]', isset($productsInfo) ? $productsInfo->translate($locale)->name : null, ['class' => 'form-control', 'required' => true]) !!}\n+                    </div>\n+\n+                    <!-- Piping Field -->\n+                    <div class=\"form-group col-sm-6\">\n+                        {!! Form::label($locale.'[piping]', '配管('.strtoupper($locale).'):') !!}\n+                        {!! Form::text($locale.'[piping]', isset($productsInfo) ? $productsInfo->translate($locale)->piping : null, ['class' => 'form-control']) !!}\n+                    </div>\n+\n+                    <!-- Glue Block Field -->\n+                    <div class=\"form-group col-sm-6\">\n+                        {!! Form::label($locale.'[glue_block]', '膠塊('.strtoupper($locale).'):') !!}\n+                        {!! Form::text($locale.'[glue_block]', isset($productsInfo) ? $productsInfo->translate($locale)->glue_block : null, ['class' => 'form-control']) !!}\n+                    </div>\n+\n+                    <!-- Introduction Field -->\n+                    <div class=\"form-group col-sm-12\">\n+                        {!! Form::label($locale.'[introduction]', '產品介紹('.strtoupper($locale).'):') !!}\n+                        {!! Form::textarea($locale.'[introduction]', isset($productsInfo) ? $productsInfo->translate($locale)->introduction : null, ['class' => 'form-control tinymce-editor tinymce-editor-introductions']) !!}\n+                    </div>\n+                </div>\n+            @endforeach\n+        </div>\n+    </div>\n+</div>\n+\n+<!-- Prod Img Cover Field -->\n+<div class=\"form-group col-sm-6\">\n+    {!! Form::label('prod_img_cover', '產品封面圖片:') !!}\n+    {{-- 尺寸說明 --}}\n+    <p class=\"text-muted\">建議尺寸: 400x328px</p>\n+    <div class=\"custom-file\">\n+        <input type=\"file\" class=\"custom-file-input\" id=\"prod_img_cover\" name=\"prod_img_cover\" accept=\"image/*\">\n+        <label class=\"custom-file-label prod_img_cover_label\" for=\"prod_img_cover\">選擇產品封面圖片</label>\n+    </div>\n+    <div class=\"img-preview-prod-img-cover mt-2\">\n+        @if (isset($productsInfo) && $productsInfo->prod_img_cover)\n+            <p>預覽</p>\n+            <img src=\"{{ asset('uploads/' . $productsInfo->prod_img_cover) }}\" style=\"max-width: 200px; max-height: 200px;\">\n+        @endif\n+    </div>\n+</div>\n+<div class=\"clearfix w-100\"></div>\n+\n+<!-- PDF Field -->\n+<div class=\"form-group col-sm-6\">\n+    {!! Form::label('pdf', '產品PDF檔案:') !!}\n+    <div class=\"custom-file\">\n+        <input type=\"file\" class=\"custom-file-input\" id=\"pdf\" name=\"pdf\" accept=\".pdf\">\n+        <label class=\"custom-file-label pdf_label\" for=\"pdf\">選擇PDF檔案</label>\n+    </div>\n+    <div class=\"mt-2\">\n+        @if (isset($productsInfo) && $productsInfo->pdf)\n+            <p>已上傳PDF檔案: <a href=\"{{ asset('uploads/' . $productsInfo->pdf) }}\" target=\"_blank\">{{ basename($productsInfo->pdf) }}</a></p>\n+        @else\n+            <p>尚未上傳PDF檔案</p>\n+        @endif\n+    </div>\n+</div>\n+\n+<!-- Product Images Field -->\n+<div class=\"form-group col-sm-12\">\n+    {!! Form::label('product_images', '產品圖片:') !!}\n+    {{-- 尺寸說明 --}}\n+    <p class=\"text-muted\">建議尺寸: 1024x648px</p>\n+    <div class=\"input-group\">\n+        <div class=\"custom-file\">\n+            <input type=\"file\" class=\"custom-file-input\" id=\"product_images\" name=\"product_images[]\" multiple\n+                accept=\"image/*\">\n+            <label class=\"custom-file-label product_images_label\" for=\"product_images\">選擇圖片（可多選）</label>\n+        </div>\n+    </div>\n+    <small class=\"text-muted\">可拖曳圖片進行排序，<span id=\"remaining-count\">剩餘可上傳: 10 張</span>，每個產品最多10張圖片</small>\n+</div>\n+\n+<!-- 圖片預覽與排序區域 -->\n+<div class=\"form-group col-sm-12\">\n+    <label>圖片預覽與排序</label>\n+    <div class=\"row sortable-container\" id=\"image-preview-container\">\n+        @if (isset($productsInfo) && $productsInfo->images->count() > 0)\n+            @foreach ($productsInfo->images as $image)\n+                <div class=\"col-md-3 mb-3 image-item\" data-image-id=\"{{ $image->id }}\">\n+                    <div class=\"card\">\n+                        <div class=\"card-header2 p-1 bg-light d-flex justify-content-between align-items-center\">\n+                            <span class=\"drag-handle\"><i class=\"fas fa-grip-lines\"></i></span>\n+                            <button type=\"button\" class=\"btn btn-sm btn-danger delete-image\"><i\n+                                    class=\"fas fa-times\"></i></button>\n+                        </div>\n+                        <img src=\"{{ asset('uploads/' . $image->image_path) }}\" class=\"card-img-top\" alt=\"產品圖片\"\n+                            style=\"height: 150px; object-fit: cover;\">\n+                        <input type=\"hidden\" name=\"image_ids[]\" value=\"{{ $image->id }}\">\n+                    </div>\n+                </div>\n+            @endforeach\n+        @endif\n+    </div>\n+</div>\n+\n+@push('third_party_stylesheets')\n+    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css\">\n+    <style>\n+        .drag-handle {\n+            cursor: move;\n+        }\n+\n+        .ui-sortable-helper {\n+            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n+        }\n+\n+        .ui-sortable-placeholder {\n+            visibility: visible !important;\n+            border: 2px dashed #ccc;\n+            background-color: #f8f9fa;\n+            height: 220px;\n+        }\n+\n+        .opacity-50 {\n+            opacity: 0.5;\n+        }\n+    </style>\n+@endpush\n+\n+@push('third_party_scripts')\n+    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js\"></script>\n+    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/axios/0.26.1/axios.min.js\"\n+        integrity=\"sha512-bPh3uwgU5qEMipS/VOmRqynnMXGGSRv+72H/N260MQeXZIK4PG48401Bsby9Nq5P5fz7hy5UGNmC/W1Z51h2GQ==\"\n+        crossorigin=\"anonymous\" referrerpolicy=\"no-referrer\"></script>\n+    {{-- <script src=\"https://cdn.tiny.cloud/1/1ugon3r0i7rnpx6jhdz4moygn9knxfai212wbqlixzr9hpi8/tinymce/6/tinymce.min.js\"\n+        referrerpolicy=\"origin\"></script> --}}\n+    <script src=\"{!! asset('vendor/tinymce/js/tinymce/tinymce.js') !!}\"></script>\n+@endpush\n+\n+@push('page_scripts')\n+    <script src=\"{{ asset('assets/admin/js/products.js') }}\" referrerpolicy=\"no-referrer\"></script>\n+    <script>\n+        const loadingSwal = Swal.fire({\n+            title: '載入中...',\n+            text: '請稍候',\n+            allowOutsideClick: false,\n+            didOpen: () => {\n+                Swal.showLoading();\n+            }\n+        });\n+\n+        // 頁面完全載入後（包含所有圖片和資源）關閉載入動畫\n+        $(window).on('load', function() {\n+            loadingSwal.close();\n+        });\n+\n+        // 也可以設定一個逾時機制，避免載入過久\n+        setTimeout(function() {\n+            loadingSwal.close();\n+        }, 5000); // 5秒後自動關閉\n+\n+        $(function() {\n+\n+            $('#brands_info_id').select2({\n+                placeholder: '請先選擇應用類別',\n+                allowClear: true\n+            });\n+\n+            $('#product_categories_id').select2({\n+                placeholder: '請先選擇應用類別',\n+                allowClear: true\n+            });\n+\n+            // prod_img_cover 檔案選擇器\n+            $('#prod_img_cover').on('change', function() {\n+                // 檢查是否選擇了檔案\n+                if (this.files.length === 0) {\n+                    // 如果沒有選擇檔案，清除預覽區域\n+                    $(this).closest('.form-group').find('.img-preview-prod-img-cover').html('');\n+                    $('.prod_img_cover_label').text('選擇產品封面圖片');\n+                    return;\n+                }\n+                let fileInput = this;\n+                let fileReader = new FileReader();\n+\n+                fileReader.onload = function(e) {\n+                    let previewHtml = `<p for=\"\">預覽</p><img src=\"${e.target.result}\" style=\"max-width: 200px; max-height: 200px;\">`;\n+                    $(fileInput).closest('.form-group').find('.img-preview-prod-img-cover').html(previewHtml);\n+                };\n+\n+                fileReader.readAsDataURL(fileInput.files[0]);\n+\n+                // 更新標籤顯示\n+                const coverFileName = this.files.length > 0 ? this.files[0].name : '選擇產品封面圖片';\n+                $('.prod_img_cover_label').text(coverFileName);\n+            });\n+\n+            // pdf 檔案選擇器\n+            $('#pdf').on('change', function() {\n+                // 更新標籤顯示\n+                const pdfFileName = this.files.length > 0 ? this.files[0].name : '選擇PDF檔案';\n+                $('.pdf_label').text(pdfFileName);\n+            });\n+\n+\n+            // 用於追蹤目前選擇的檔案\n+            let selectedFiles = [];\n+            let fileIndices = {};\n+\n+            // 圖片數量限制\n+            const MAX_IMAGES = 10;\n+\n+            // 顯示檔案名稱\n+            $('#product_images').on('change', function() {\n+                const inputFiles = Array.from(this.files);\n+\n+                // 檢查總圖片數量是否會超過限制\n+                const existingImageCount = $('.image-item').not('.new-image').not('.opacity-50').length;\n+                const totalImagesAfterUpload = existingImageCount + inputFiles.length;\n+\n+                if (totalImagesAfterUpload > MAX_IMAGES) {\n+                    alert(`每個產品最多只能有 ${MAX_IMAGES} 張圖片。目前已有 ${existingImageCount} 張，您選擇了 ${inputFiles.length} 張。`);\n+                    resetFileInput();\n+                    return;\n+                }\n+\n+                // 儲存選擇的檔案\n+                selectedFiles = inputFiles;\n+\n+                // 更新顯示的檔案名稱\n+                updateFileLabel();\n+\n+                // 清除之前的新圖片預覽\n+                $('.new-image').remove();\n+\n+                // 預覽新上傳的圖片\n+                selectedFiles.forEach((file, index) => {\n+                    fileIndices[index] = index; // 追蹤原始索引\n+                    const reader = new FileReader();\n+\n+                    reader.onload = function(e) {\n+                        // 建立新圖片預覽區塊\n+                        const imageItemHtml = `\n+                        <div class=\"col-md-3 mb-3 image-item new-image\" data-file-index=\"${index}\">\n+                            <div class=\"card\">\n+                                <div class=\"card-header2 p-1 bg-light d-flex justify-content-between align-items-center\">\n+                                    <span class=\"drag-handle\"><i class=\"fas fa-grip-lines\"></i></span>\n+                                    <button type=\"button\" class=\"btn btn-sm btn-danger delete-new-image\"><i class=\"fas fa-times\"></i></button>\n+                                </div>\n+                                <img src=\"${e.target.result}\" class=\"card-img-top\" alt=\"新圖片預覽\" style=\"height: 150px; object-fit: cover;\">\n+                                <div class=\"card-footer p-1 text-center\">\n+                                    <small class=\"text-muted\">${file.name}</small>\n+                                </div>\n+                                <input type=\"hidden\" name=\"new_images[]\" value=\"${index}\">\n+                            </div>\n+                        </div>\n+                    `;\n+\n+                        $('#image-preview-container').append(imageItemHtml);\n+\n+                        // 重新初始化排序功能\n+                        initSortable();\n+                    };\n+\n+                    reader.readAsDataURL(file);\n+                });\n+            });\n+\n+            // 更新檔案標籤顯示\n+            function updateFileLabel() {\n+                const fileNames = selectedFiles.map(file => file.name);\n+                if (fileNames.length > 0) {\n+                    $('.product_images_label').html(fileNames.join(', '));\n+                } else {\n+                    $('.product_images_label').html('選擇圖片（可多選）');\n+                }\n+            }\n+\n+            // 在產品圖片區域顯示剩餘可上傳數量\n+            function updateRemainingCount() {\n+                const existingImageCount = $('.image-item').not('.opacity-50').length;\n+                const remainingCount = MAX_IMAGES - existingImageCount;\n+\n+                $('#remaining-count').text(`剩餘可上傳: ${remainingCount} 張`);\n+\n+                // 如果已達上限，禁用上傳按鈕\n+                if (remainingCount <= 0) {\n+                    $('#product_images').prop('disabled', true);\n+                    $('.product_images_label').text('已達上傳上限');\n+                } else {\n+                    $('#product_images').prop('disabled', false);\n+                }\n+            }\n+\n+            // 初始更新剩餘數量\n+            updateRemainingCount();\n+\n+            // 初始化拖曳排序\n+            function initSortable() {\n+                $('.sortable-container').sortable({\n+                    items: '.image-item',\n+                    handle: '.drag-handle',\n+                    cursor: 'move',\n+                    placeholder: 'col-md-3 mb-3 ui-sortable-placeholder',\n+                    update: function(event, ui) {\n+                        // 更新排序順序（將在表單提交時處理）\n+                    }\n+                }).disableSelection();\n+            }\n+\n+            // 初始化排序功能\n+            initSortable();\n+\n+            // 刪除現有圖片\n+            $(document).on('click', '.delete-image', function() {\n+                const imageItem = $(this).closest('.image-item');\n+                const imageId = imageItem.data('image-id');\n+\n+                // 添加一個隱藏欄位，標記要刪除的圖片\n+                $('<input>').attr({\n+                    type: 'hidden',\n+                    name: 'delete_images[]',\n+                    value: imageId\n+                }).appendTo('form');\n+\n+                // 視覺上標記為刪除，而不是完全移除\n+                imageItem.addClass('opacity-50');\n+                $(this).removeClass('btn-danger').addClass('btn-success').html(\n+                    '<i class=\"fas fa-undo\"></i>');\n+                $(this).removeClass('delete-image').addClass('restore-image');\n+\n+                // 更新剩餘可上傳數量\n+                updateRemainingCount();\n+            });\n+\n+            // 復原刪除現有圖片\n+            $(document).on('click', '.restore-image', function() {\n+                const imageItem = $(this).closest('.image-item');\n+                const imageId = imageItem.data('image-id');\n+\n+                // 移除標記刪除的隱藏欄位\n+                $('input[name=\"delete_images[]\"][value=\"' + imageId + '\"]').remove();\n+\n+                // 視覺上恢復正常\n+                imageItem.removeClass('opacity-50');\n+                $(this).removeClass('btn-success').addClass('btn-danger').html(\n+                    '<i class=\"fas fa-times\"></i>');\n+                $(this).removeClass('restore-image').addClass('delete-image');\n+\n+                // 更新剩餘可上傳數量\n+                updateRemainingCount();\n+            });\n+\n+            // 刪除新上傳的圖片預覽\n+            $(document).on('click', '.delete-new-image', function() {\n+                const imageItem = $(this).closest('.image-item');\n+                const fileIndex = imageItem.data('file-index');\n+\n+                // 從選取的檔案陣列中移除此檔案\n+                if (fileIndex !== undefined) {\n+                    // 移除檔案\n+                    selectedFiles = selectedFiles.filter((_, index) => index !== fileIndex);\n+\n+                    // 更新檔案索引映射\n+                    const newFileIndices = {};\n+                    let newIndex = 0;\n+\n+                    for (let i = 0; i < selectedFiles.length; i++) {\n+                        if (i !== fileIndex) {\n+                            newFileIndices[newIndex] = i;\n+                            newIndex++;\n+                        }\n+                    }\n+\n+                    fileIndices = newFileIndices;\n+\n+                    // 更新顯示標籤\n+                    updateFileLabel();\n+                }\n+\n+                // 移除預覽\n+                imageItem.remove();\n+\n+                // 檢查是否還有新圖片預覽，如果沒有則重置檔案選擇器\n+                if ($('.new-image').length === 0) {\n+                    resetFileInput();\n+                }\n+\n+                // 更新剩餘可上傳數量\n+                updateRemainingCount();\n+            });\n+\n+            // 重置檔案選擇器\n+            function resetFileInput() {\n+                // 清空檔案選擇器的值\n+                $('#product_images').val('');\n+\n+                // 清空選取的檔案陣列\n+                selectedFiles = [];\n+                fileIndices = {};\n+\n+                // 重置標籤文字\n+                $('.product_images_label').html('選擇圖片（可多選）');\n+            }\n+\n+            // 表單提交前處理\n+            $('form').on('submit', function() {\n+                // 檢查總圖片數量是否超過限制\n+                const visibleImageCount = $('.image-item').not('.opacity-50').length;\n+                const newImageCount = $('.new-image').length;\n+\n+                // 計算實際有效圖片數（現有未刪除 + 新上傳）\n+                const activeImageCount = visibleImageCount - newImageCount + selectedFiles.length;\n+\n+                if (activeImageCount > MAX_IMAGES) {\n+                    alert(`每個產品最多只能有 ${MAX_IMAGES} 張圖片，請刪除部分圖片後再提交。`);\n+                    return false;\n+                }\n+\n+                // 處理混合排序情況\n+                let sortOrder = 0;\n+\n+                // 取得所有圖片元素（包括現有和新上傳的）\n+                $('.sortable-container .image-item').not('.opacity-50').each(function() {\n+                    // 檢查是否為現有圖片\n+                    const imageId = $(this).data('image-id');\n+                    if (imageId) {\n+                        // 更新現有圖片的排序值\n+                        $(this).find('input[name=\"image_ids[]\"]').val(imageId);\n+                        $(this).append('<input type=\"hidden\" name=\"sort_orders[' + imageId +\n+                            ']\" value=\"' + sortOrder + '\">');\n+                    }\n+\n+                    // 檢查是否為新上傳圖片\n+                    const fileIndex = $(this).data('file-index');\n+                    if (fileIndex !== undefined) {\n+                        // 確保新圖片的排序值正確\n+                        $(this).find('input[name=\"new_images[]\"]').val(fileIndex);\n+                        $(this).append('<input type=\"hidden\" name=\"new_sort_orders[]\" value=\"' +\n+                            sortOrder + '\">');\n+                    }\n+\n+                    sortOrder++;\n+                });\n+\n+                return true;\n+            });\n+\n+\n+\n+            // 儲存當前產品的品牌和產品類別ID (如果是編輯頁面)\n+            var currentBrandId = {{ isset($productsInfo) && $productsInfo->brands_info_id ? $productsInfo->brands_info_id : 'null' }};\n+            var currentProductCategoryIds = @if(isset($productsInfo) && $productsInfo->productCategories)\n+                               {!! json_encode($productsInfo->productCategories->pluck('id')->toArray()) !!}\n+                               @else [] @endif;\n+            $('#purchase_lease_container').hide();\n+            // 應用類別選擇變更事件\n+            $('#application_categories_info_id').on('change', function() {\n+                var applicationCategoryId = $(this).val();\n+\n+                // 控制 purchase_lease 欄位顯示和必填狀態\n+                if (applicationCategoryId == 1) { // 1為建設機械\n+                    $('#purchase_lease_container').show();\n+                    $('#purchase_lease').prop('required', true);\n+                } else {\n+                    $('#purchase_lease_container').hide();\n+                    $('#purchase_lease').prop('required', false);\n+                    $('#purchase_lease').val(''); // 清空選擇的值\n+                }\n+\n+                // 清空產品品牌和產品類別下拉選單\n+                $('#brands_info_id').empty().append('<option value=\"\">請選擇</option>');\n+                $('#product_categories_id').empty().append('<option value=\"\">請選擇</option>');\n+\n+                if (!applicationCategoryId) {\n+                    return;\n+                }\n+\n+                // 發送 AJAX 請求獲取對應數據\n+                $.ajax({\n+                    url: \"{{ localized_route('admin.get-categories-data') }}\",\n+                    type: 'GET',\n+                    data: {\n+                        application_category_id: applicationCategoryId\n+                    },\n+                    dataType: 'json',\n+                    success: function(response) {\n+                        // 填充產品品牌下拉選單\n+                        if (response.brands && Object.keys(response.brands).length > 0) {\n+                            $.each(response.brands, function(id, name) {\n+                                $('#brands_info_id').append(\n+                                    $('<option></option>').val(id).text(name)\n+                                );\n+                            });\n+\n+                            // 如果是編輯頁面，選中原有的品牌\n+                            if (currentBrandId) {\n+                                $('#brands_info_id').val(currentBrandId);\n+                            }\n+                        }\n+\n+                        // 填充產品類別下拉選單\n+                        if (response.productCategories && Object.keys(response.productCategories).length > 0) {\n+                            $.each(response.productCategories, function(id, name) {\n+                                $('#product_categories_id').append(\n+                                    $('<option></option>').val(id).text(name)\n+                                );\n+                            });\n+\n+                            // 如果是編輯頁面，選中原有的產品類別(使用正確的變數名稱)\n+                            if (currentProductCategoryIds && currentProductCategoryIds.length > 0) {\n+                                $('#product_categories_id').val(currentProductCategoryIds);\n+                                // 觸發change事件以更新Select2顯示\n+                                $('#product_categories_id').trigger('change');\n+                            }\n+                        }\n+                    },\n+                    error: function(xhr, status, error) {\n+                        console.error('獲取數據失敗:', error);\n+                    }\n+                });\n+            });\n+\n+            // 如果是編輯頁面，初始加載相關數據\n+            if ($('#application_categories_info_id').val()) {\n+                $('#application_categories_info_id').trigger('change');\n+            }\n+\n+            // 頁面載入時初始化購買/租賃欄位的狀態\n+            $(document).ready(function() {\n+                // 檢查並設置 purchase_lease 欄位的初始顯示狀態\n+                if ($('#application_categories_info_id').val() == 1) {\n+                    $('#purchase_lease_container').show();\n+                    $('#purchase_lease').prop('required', true);\n+\n+                    // 如果是編輯頁面，設置已保存的值\n+                    @if(isset($productsInfo) && $productsInfo->purchase_lease)\n+                        $('#purchase_lease').val('{{ $productsInfo->purchase_lease }}');\n+                    @endif\n+                } else {\n+                    $('#purchase_lease_container').hide();\n+                    $('#purchase_lease').prop('required', false);\n+                }\n+            });\n+        });\n+    </script>\n+@endpush\n"
                },
                {
                    "date": 1753268649175,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -21,9 +21,9 @@\n \n <!-- Product Categories Id Field -->\n <div class=\"form-group col-sm-4\">\n     {!! Form::label('product_categories_id', '產品類別:') !!}\n-    {!! Form::select('product_categories_id', [], null, ['class' => 'form-control', 'id' => 'product_categories_id', 'placeholder' => '請先選擇應用類別', 'multiple', 'required' => true]) !!}\n+    {!! Form::select('product_categories_id[]', [], null, ['class' => 'form-control', 'id' => 'product_categories_id', 'placeholder' => '請先選擇應用類別', 'multiple', 'required' => true]) !!}\n </div>\n \n <!-- Version Field -->\n <div class=\"form-group col-sm-4\">\n@@ -610,612 +610,4 @@\n             });\n         });\n     </script>\n @endpush\n-<!-- Application Categories Info Id Field -->\n-<div class=\"form-group col-sm-6\">\n-    {!! Form::label('application_categories_info_id', '應用類別:', ['class' => 'control-label', 'style' => 'font-weight:bold !important;']) !!}\n-    {!! Form::select('application_categories_info_id', $applicationCategoriesInfos, isset($productCategoriesInfo) ? $productCategoriesInfo->application_categories_info_id : null, ['class' => 'form-control', 'id' => 'application_categories_info_id', 'placeholder' => '請選擇', 'required' => true]) !!}\n-    {{-- <small>※請選擇應用類別</small> --}}\n-</div>\n-<div class=\"clearfix w-100\"></div>\n-\n-<!-- Purchase_Lease Field -->\n-<div class=\"form-group col-sm-6\" id=\"purchase_lease_container\">\n-    {!! Form::label('purchase_lease', '產品購買/租賃:') !!}\n-    {!! Form::select('purchase_lease', ['' => '請選擇', 'purchase' => '購買', 'lease' => '租賃'], null, ['class' => 'form-control', 'id' => 'purchase_lease', 'placeholder' => '請選擇產品購買/租賃方式', 'required' => true]) !!}\n-</div>\n-<div class=\"clearfix w-100\"></div>\n-\n-<!-- Brands Info Id Field -->\n-<div class=\"form-group col-sm-4\">\n-    {!! Form::label('brands_info_id', '產品品牌:') !!}\n-    {!! Form::select('brands_info_id', [], null, ['class' => 'form-control', 'placeholder' => '請先選擇應用類別', 'id' => 'brands_info_id', 'required' => true]) !!}\n-</div>\n-\n-<!-- Product Categories Id Field -->\n-<div class=\"form-group col-sm-4\">\n-    {!! Form::label('product_categories_id', '產品類別:') !!}\n-    {!! Form::select('product_categories_id', [], null, ['class' => 'form-control', 'id' => 'product_categories_id', 'placeholder' => '請先選擇應用類別', 'multiple', 'required' => true]) !!}\n-</div>\n-\n-<!-- Version Field -->\n-<div class=\"form-group col-sm-4\">\n-    {!! Form::label('version', '產品型號(機型版本):') !!}\n-    {!! Form::text('version', null, ['class' => 'form-control']) !!}\n-</div>\n-<div class=\"clearfix w-100\"></div>\n-\n-<!-- 'bootstrap / Toggle Switch Quick Bucket Changer Field' -->\n-<div class=\"form-group col-sm-6\">\n-    <div class=\"custom-control custom-switch\">\n-        {!! Form::checkbox('quick_bucket_changer', 1, null,  ['class' => 'custom-control-input', 'id' => 'quick_bucket_changer']) !!}\n-        {!! Form::label('quick_bucket_changer', '快速換斗器', ['class' => 'custom-control-label']) !!}\n-    </div>\n-</div>\n-<div class=\"clearfix w-100\"></div>\n-\n-<!-- 'bootstrap / Toggle Switch Operating Converter Field' -->\n-<div class=\"form-group col-sm-6\">\n-    <div class=\"custom-control custom-switch\">\n-        {!! Form::checkbox('operating_converter', 1, null,  ['class' => 'custom-control-input', 'id' => 'operating_converter']) !!}\n-        {!! Form::label('operating_converter', '操作轉換器', ['class' => 'custom-control-label']) !!}\n-    </div>\n-</div>\n-<div class=\"clearfix w-100\"></div>\n-\n-<!-- 多語系欄位 -->\n-<div class=\"card col-sm-12\">\n-    <div class=\"card-header\">\n-        <ul class=\"nav nav-tabs card-header-tabs\" role=\"tablist\">\n-            @foreach(config('translatable.locales') as $locale)\n-                <li class=\"nav-item\">\n-                    <a class=\"nav-link {{ $loop->first ? 'active' : '' }}\" data-toggle=\"tab\" href=\"#{{ $locale }}\" role=\"tab\">\n-                        {{ strtoupper($locale) === 'ZH_TW' ? '中文' : 'English' }} 語系\n-                    </a>\n-                </li>\n-            @endforeach\n-        </ul>\n-    </div>\n-    <div class=\"card-body\">\n-        <div class=\"tab-content\">\n-            @foreach(config('translatable.locales') as $locale)\n-                <div class=\"tab-pane {{ $loop->first ? 'active' : '' }}\" id=\"{{ $locale }}\" role=\"tabpanel\">\n-\n-                    <!-- Name Field -->\n-                    <div class=\"form-group col-sm-6\">\n-                        {!! Form::label($locale.'[name]', '產品名稱('.strtoupper($locale).'):') !!}\n-                        {!! Form::text($locale.'[name]', isset($productsInfo) ? $productsInfo->translate($locale)->name : null, ['class' => 'form-control', 'required' => true]) !!}\n-                    </div>\n-\n-                    <!-- Piping Field -->\n-                    <div class=\"form-group col-sm-6\">\n-                        {!! Form::label($locale.'[piping]', '配管('.strtoupper($locale).'):') !!}\n-                        {!! Form::text($locale.'[piping]', isset($productsInfo) ? $productsInfo->translate($locale)->piping : null, ['class' => 'form-control']) !!}\n-                    </div>\n-\n-                    <!-- Glue Block Field -->\n-                    <div class=\"form-group col-sm-6\">\n-                        {!! Form::label($locale.'[glue_block]', '膠塊('.strtoupper($locale).'):') !!}\n-                        {!! Form::text($locale.'[glue_block]', isset($productsInfo) ? $productsInfo->translate($locale)->glue_block : null, ['class' => 'form-control']) !!}\n-                    </div>\n-\n-                    <!-- Introduction Field -->\n-                    <div class=\"form-group col-sm-12\">\n-                        {!! Form::label($locale.'[introduction]', '產品介紹('.strtoupper($locale).'):') !!}\n-                        {!! Form::textarea($locale.'[introduction]', isset($productsInfo) ? $productsInfo->translate($locale)->introduction : null, ['class' => 'form-control tinymce-editor tinymce-editor-introductions']) !!}\n-                    </div>\n-                </div>\n-            @endforeach\n-        </div>\n-    </div>\n-</div>\n-\n-<!-- Prod Img Cover Field -->\n-<div class=\"form-group col-sm-6\">\n-    {!! Form::label('prod_img_cover', '產品封面圖片:') !!}\n-    {{-- 尺寸說明 --}}\n-    <p class=\"text-muted\">建議尺寸: 400x328px</p>\n-    <div class=\"custom-file\">\n-        <input type=\"file\" class=\"custom-file-input\" id=\"prod_img_cover\" name=\"prod_img_cover\" accept=\"image/*\">\n-        <label class=\"custom-file-label prod_img_cover_label\" for=\"prod_img_cover\">選擇產品封面圖片</label>\n-    </div>\n-    <div class=\"img-preview-prod-img-cover mt-2\">\n-        @if (isset($productsInfo) && $productsInfo->prod_img_cover)\n-            <p>預覽</p>\n-            <img src=\"{{ asset('uploads/' . $productsInfo->prod_img_cover) }}\" style=\"max-width: 200px; max-height: 200px;\">\n-        @endif\n-    </div>\n-</div>\n-<div class=\"clearfix w-100\"></div>\n-\n-<!-- PDF Field -->\n-<div class=\"form-group col-sm-6\">\n-    {!! Form::label('pdf', '產品PDF檔案:') !!}\n-    <div class=\"custom-file\">\n-        <input type=\"file\" class=\"custom-file-input\" id=\"pdf\" name=\"pdf\" accept=\".pdf\">\n-        <label class=\"custom-file-label pdf_label\" for=\"pdf\">選擇PDF檔案</label>\n-    </div>\n-    <div class=\"mt-2\">\n-        @if (isset($productsInfo) && $productsInfo->pdf)\n-            <p>已上傳PDF檔案: <a href=\"{{ asset('uploads/' . $productsInfo->pdf) }}\" target=\"_blank\">{{ basename($productsInfo->pdf) }}</a></p>\n-        @else\n-            <p>尚未上傳PDF檔案</p>\n-        @endif\n-    </div>\n-</div>\n-\n-<!-- Product Images Field -->\n-<div class=\"form-group col-sm-12\">\n-    {!! Form::label('product_images', '產品圖片:') !!}\n-    {{-- 尺寸說明 --}}\n-    <p class=\"text-muted\">建議尺寸: 1024x648px</p>\n-    <div class=\"input-group\">\n-        <div class=\"custom-file\">\n-            <input type=\"file\" class=\"custom-file-input\" id=\"product_images\" name=\"product_images[]\" multiple\n-                accept=\"image/*\">\n-            <label class=\"custom-file-label product_images_label\" for=\"product_images\">選擇圖片（可多選）</label>\n-        </div>\n-    </div>\n-    <small class=\"text-muted\">可拖曳圖片進行排序，<span id=\"remaining-count\">剩餘可上傳: 10 張</span>，每個產品最多10張圖片</small>\n-</div>\n-\n-<!-- 圖片預覽與排序區域 -->\n-<div class=\"form-group col-sm-12\">\n-    <label>圖片預覽與排序</label>\n-    <div class=\"row sortable-container\" id=\"image-preview-container\">\n-        @if (isset($productsInfo) && $productsInfo->images->count() > 0)\n-            @foreach ($productsInfo->images as $image)\n-                <div class=\"col-md-3 mb-3 image-item\" data-image-id=\"{{ $image->id }}\">\n-                    <div class=\"card\">\n-                        <div class=\"card-header2 p-1 bg-light d-flex justify-content-between align-items-center\">\n-                            <span class=\"drag-handle\"><i class=\"fas fa-grip-lines\"></i></span>\n-                            <button type=\"button\" class=\"btn btn-sm btn-danger delete-image\"><i\n-                                    class=\"fas fa-times\"></i></button>\n-                        </div>\n-                        <img src=\"{{ asset('uploads/' . $image->image_path) }}\" class=\"card-img-top\" alt=\"產品圖片\"\n-                            style=\"height: 150px; object-fit: cover;\">\n-                        <input type=\"hidden\" name=\"image_ids[]\" value=\"{{ $image->id }}\">\n-                    </div>\n-                </div>\n-            @endforeach\n-        @endif\n-    </div>\n-</div>\n-\n-@push('third_party_stylesheets')\n-    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css\">\n-    <style>\n-        .drag-handle {\n-            cursor: move;\n-        }\n-\n-        .ui-sortable-helper {\n-            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n-        }\n-\n-        .ui-sortable-placeholder {\n-            visibility: visible !important;\n-            border: 2px dashed #ccc;\n-            background-color: #f8f9fa;\n-            height: 220px;\n-        }\n-\n-        .opacity-50 {\n-            opacity: 0.5;\n-        }\n-    </style>\n-@endpush\n-\n-@push('third_party_scripts')\n-    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js\"></script>\n-    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/axios/0.26.1/axios.min.js\"\n-        integrity=\"sha512-bPh3uwgU5qEMipS/VOmRqynnMXGGSRv+72H/N260MQeXZIK4PG48401Bsby9Nq5P5fz7hy5UGNmC/W1Z51h2GQ==\"\n-        crossorigin=\"anonymous\" referrerpolicy=\"no-referrer\"></script>\n-    {{-- <script src=\"https://cdn.tiny.cloud/1/1ugon3r0i7rnpx6jhdz4moygn9knxfai212wbqlixzr9hpi8/tinymce/6/tinymce.min.js\"\n-        referrerpolicy=\"origin\"></script> --}}\n-    <script src=\"{!! asset('vendor/tinymce/js/tinymce/tinymce.js') !!}\"></script>\n-@endpush\n-\n-@push('page_scripts')\n-    <script src=\"{{ asset('assets/admin/js/products.js') }}\" referrerpolicy=\"no-referrer\"></script>\n-    <script>\n-        const loadingSwal = Swal.fire({\n-            title: '載入中...',\n-            text: '請稍候',\n-            allowOutsideClick: false,\n-            didOpen: () => {\n-                Swal.showLoading();\n-            }\n-        });\n-\n-        // 頁面完全載入後（包含所有圖片和資源）關閉載入動畫\n-        $(window).on('load', function() {\n-            loadingSwal.close();\n-        });\n-\n-        // 也可以設定一個逾時機制，避免載入過久\n-        setTimeout(function() {\n-            loadingSwal.close();\n-        }, 5000); // 5秒後自動關閉\n-\n-        $(function() {\n-\n-            $('#product_categories_id').select2({\n-                placeholder: '請先選擇應用類別',\n-                allowClear: true\n-            });\n-\n-            // prod_img_cover 檔案選擇器\n-            $('#prod_img_cover').on('change', function() {\n-                // 檢查是否選擇了檔案\n-                if (this.files.length === 0) {\n-                    // 如果沒有選擇檔案，清除預覽區域\n-                    $(this).closest('.form-group').find('.img-preview-prod-img-cover').html('');\n-                    $('.prod_img_cover_label').text('選擇產品封面圖片');\n-                    return;\n-                }\n-                let fileInput = this;\n-                let fileReader = new FileReader();\n-\n-                fileReader.onload = function(e) {\n-                    let previewHtml = `<p for=\"\">預覽</p><img src=\"${e.target.result}\" style=\"max-width: 200px; max-height: 200px;\">`;\n-                    $(fileInput).closest('.form-group').find('.img-preview-prod-img-cover').html(previewHtml);\n-                };\n-\n-                fileReader.readAsDataURL(fileInput.files[0]);\n-\n-                // 更新標籤顯示\n-                const coverFileName = this.files.length > 0 ? this.files[0].name : '選擇產品封面圖片';\n-                $('.prod_img_cover_label').text(coverFileName);\n-            });\n-\n-            // pdf 檔案選擇器\n-            $('#pdf').on('change', function() {\n-                // 更新標籤顯示\n-                const pdfFileName = this.files.length > 0 ? this.files[0].name : '選擇PDF檔案';\n-                $('.pdf_label').text(pdfFileName);\n-            });\n-\n-\n-            // 用於追蹤目前選擇的檔案\n-            let selectedFiles = [];\n-            let fileIndices = {};\n-\n-            // 圖片數量限制\n-            const MAX_IMAGES = 10;\n-\n-            // 顯示檔案名稱\n-            $('#product_images').on('change', function() {\n-                const inputFiles = Array.from(this.files);\n-\n-                // 檢查總圖片數量是否會超過限制\n-                const existingImageCount = $('.image-item').not('.new-image').not('.opacity-50').length;\n-                const totalImagesAfterUpload = existingImageCount + inputFiles.length;\n-\n-                if (totalImagesAfterUpload > MAX_IMAGES) {\n-                    alert(`每個產品最多只能有 ${MAX_IMAGES} 張圖片。目前已有 ${existingImageCount} 張，您選擇了 ${inputFiles.length} 張。`);\n-                    resetFileInput();\n-                    return;\n-                }\n-\n-                // 儲存選擇的檔案\n-                selectedFiles = inputFiles;\n-\n-                // 更新顯示的檔案名稱\n-                updateFileLabel();\n-\n-                // 清除之前的新圖片預覽\n-                $('.new-image').remove();\n-\n-                // 預覽新上傳的圖片\n-                selectedFiles.forEach((file, index) => {\n-                    fileIndices[index] = index; // 追蹤原始索引\n-                    const reader = new FileReader();\n-\n-                    reader.onload = function(e) {\n-                        // 建立新圖片預覽區塊\n-                        const imageItemHtml = `\n-                        <div class=\"col-md-3 mb-3 image-item new-image\" data-file-index=\"${index}\">\n-                            <div class=\"card\">\n-                                <div class=\"card-header2 p-1 bg-light d-flex justify-content-between align-items-center\">\n-                                    <span class=\"drag-handle\"><i class=\"fas fa-grip-lines\"></i></span>\n-                                    <button type=\"button\" class=\"btn btn-sm btn-danger delete-new-image\"><i class=\"fas fa-times\"></i></button>\n-                                </div>\n-                                <img src=\"${e.target.result}\" class=\"card-img-top\" alt=\"新圖片預覽\" style=\"height: 150px; object-fit: cover;\">\n-                                <div class=\"card-footer p-1 text-center\">\n-                                    <small class=\"text-muted\">${file.name}</small>\n-                                </div>\n-                                <input type=\"hidden\" name=\"new_images[]\" value=\"${index}\">\n-                            </div>\n-                        </div>\n-                    `;\n-\n-                        $('#image-preview-container').append(imageItemHtml);\n-\n-                        // 重新初始化排序功能\n-                        initSortable();\n-                    };\n-\n-                    reader.readAsDataURL(file);\n-                });\n-            });\n-\n-            // 更新檔案標籤顯示\n-            function updateFileLabel() {\n-                const fileNames = selectedFiles.map(file => file.name);\n-                if (fileNames.length > 0) {\n-                    $('.product_images_label').html(fileNames.join(', '));\n-                } else {\n-                    $('.product_images_label').html('選擇圖片（可多選）');\n-                }\n-            }\n-\n-            // 在產品圖片區域顯示剩餘可上傳數量\n-            function updateRemainingCount() {\n-                const existingImageCount = $('.image-item').not('.opacity-50').length;\n-                const remainingCount = MAX_IMAGES - existingImageCount;\n-\n-                $('#remaining-count').text(`剩餘可上傳: ${remainingCount} 張`);\n-\n-                // 如果已達上限，禁用上傳按鈕\n-                if (remainingCount <= 0) {\n-                    $('#product_images').prop('disabled', true);\n-                    $('.product_images_label').text('已達上傳上限');\n-                } else {\n-                    $('#product_images').prop('disabled', false);\n-                }\n-            }\n-\n-            // 初始更新剩餘數量\n-            updateRemainingCount();\n-\n-            // 初始化拖曳排序\n-            function initSortable() {\n-                $('.sortable-container').sortable({\n-                    items: '.image-item',\n-                    handle: '.drag-handle',\n-                    cursor: 'move',\n-                    placeholder: 'col-md-3 mb-3 ui-sortable-placeholder',\n-                    update: function(event, ui) {\n-                        // 更新排序順序（將在表單提交時處理）\n-                    }\n-                }).disableSelection();\n-            }\n-\n-            // 初始化排序功能\n-            initSortable();\n-\n-            // 刪除現有圖片\n-            $(document).on('click', '.delete-image', function() {\n-                const imageItem = $(this).closest('.image-item');\n-                const imageId = imageItem.data('image-id');\n-\n-                // 添加一個隱藏欄位，標記要刪除的圖片\n-                $('<input>').attr({\n-                    type: 'hidden',\n-                    name: 'delete_images[]',\n-                    value: imageId\n-                }).appendTo('form');\n-\n-                // 視覺上標記為刪除，而不是完全移除\n-                imageItem.addClass('opacity-50');\n-                $(this).removeClass('btn-danger').addClass('btn-success').html(\n-                    '<i class=\"fas fa-undo\"></i>');\n-                $(this).removeClass('delete-image').addClass('restore-image');\n-\n-                // 更新剩餘可上傳數量\n-                updateRemainingCount();\n-            });\n-\n-            // 復原刪除現有圖片\n-            $(document).on('click', '.restore-image', function() {\n-                const imageItem = $(this).closest('.image-item');\n-                const imageId = imageItem.data('image-id');\n-\n-                // 移除標記刪除的隱藏欄位\n-                $('input[name=\"delete_images[]\"][value=\"' + imageId + '\"]').remove();\n-\n-                // 視覺上恢復正常\n-                imageItem.removeClass('opacity-50');\n-                $(this).removeClass('btn-success').addClass('btn-danger').html(\n-                    '<i class=\"fas fa-times\"></i>');\n-                $(this).removeClass('restore-image').addClass('delete-image');\n-\n-                // 更新剩餘可上傳數量\n-                updateRemainingCount();\n-            });\n-\n-            // 刪除新上傳的圖片預覽\n-            $(document).on('click', '.delete-new-image', function() {\n-                const imageItem = $(this).closest('.image-item');\n-                const fileIndex = imageItem.data('file-index');\n-\n-                // 從選取的檔案陣列中移除此檔案\n-                if (fileIndex !== undefined) {\n-                    // 移除檔案\n-                    selectedFiles = selectedFiles.filter((_, index) => index !== fileIndex);\n-\n-                    // 更新檔案索引映射\n-                    const newFileIndices = {};\n-                    let newIndex = 0;\n-\n-                    for (let i = 0; i < selectedFiles.length; i++) {\n-                        if (i !== fileIndex) {\n-                            newFileIndices[newIndex] = i;\n-                            newIndex++;\n-                        }\n-                    }\n-\n-                    fileIndices = newFileIndices;\n-\n-                    // 更新顯示標籤\n-                    updateFileLabel();\n-                }\n-\n-                // 移除預覽\n-                imageItem.remove();\n-\n-                // 檢查是否還有新圖片預覽，如果沒有則重置檔案選擇器\n-                if ($('.new-image').length === 0) {\n-                    resetFileInput();\n-                }\n-\n-                // 更新剩餘可上傳數量\n-                updateRemainingCount();\n-            });\n-\n-            // 重置檔案選擇器\n-            function resetFileInput() {\n-                // 清空檔案選擇器的值\n-                $('#product_images').val('');\n-\n-                // 清空選取的檔案陣列\n-                selectedFiles = [];\n-                fileIndices = {};\n-\n-                // 重置標籤文字\n-                $('.product_images_label').html('選擇圖片（可多選）');\n-            }\n-\n-            // 表單提交前處理\n-            $('form').on('submit', function() {\n-                // 檢查總圖片數量是否超過限制\n-                const visibleImageCount = $('.image-item').not('.opacity-50').length;\n-                const newImageCount = $('.new-image').length;\n-\n-                // 計算實際有效圖片數（現有未刪除 + 新上傳）\n-                const activeImageCount = visibleImageCount - newImageCount + selectedFiles.length;\n-\n-                if (activeImageCount > MAX_IMAGES) {\n-                    alert(`每個產品最多只能有 ${MAX_IMAGES} 張圖片，請刪除部分圖片後再提交。`);\n-                    return false;\n-                }\n-\n-                // 處理混合排序情況\n-                let sortOrder = 0;\n-\n-                // 取得所有圖片元素（包括現有和新上傳的）\n-                $('.sortable-container .image-item').not('.opacity-50').each(function() {\n-                    // 檢查是否為現有圖片\n-                    const imageId = $(this).data('image-id');\n-                    if (imageId) {\n-                        // 更新現有圖片的排序值\n-                        $(this).find('input[name=\"image_ids[]\"]').val(imageId);\n-                        $(this).append('<input type=\"hidden\" name=\"sort_orders[' + imageId +\n-                            ']\" value=\"' + sortOrder + '\">');\n-                    }\n-\n-                    // 檢查是否為新上傳圖片\n-                    const fileIndex = $(this).data('file-index');\n-                    if (fileIndex !== undefined) {\n-                        // 確保新圖片的排序值正確\n-                        $(this).find('input[name=\"new_images[]\"]').val(fileIndex);\n-                        $(this).append('<input type=\"hidden\" name=\"new_sort_orders[]\" value=\"' +\n-                            sortOrder + '\">');\n-                    }\n-\n-                    sortOrder++;\n-                });\n-\n-                return true;\n-            });\n-\n-\n-\n-            // 儲存當前產品的品牌和產品類別ID (如果是編輯頁面)\n-            var currentBrandId = {{ isset($productsInfo) && $productsInfo->brands_info_id ? $productsInfo->brands_info_id : 'null' }};\n-            var currentProductCategoryIds = @if(isset($productsInfo) && $productsInfo->productCategories)\n-                               {!! json_encode($productsInfo->productCategories->pluck('id')->toArray()) !!}\n-                               @else [] @endif;\n-            $('#purchase_lease_container').hide();\n-            // 應用類別選擇變更事件\n-            $('#application_categories_info_id').on('change', function() {\n-                var applicationCategoryId = $(this).val();\n-\n-                // 控制 purchase_lease 欄位顯示和必填狀態\n-                if (applicationCategoryId == 1) { // 1為建設機械\n-                    $('#purchase_lease_container').show();\n-                    $('#purchase_lease').prop('required', true);\n-                } else {\n-                    $('#purchase_lease_container').hide();\n-                    $('#purchase_lease').prop('required', false);\n-                    $('#purchase_lease').val(''); // 清空選擇的值\n-                }\n-\n-                // 清空產品品牌和產品類別下拉選單\n-                $('#brands_info_id').empty().append('<option value=\"\">請選擇</option>');\n-                $('#product_categories_id').empty().append('<option value=\"\">請選擇</option>');\n-\n-                if (!applicationCategoryId) {\n-                    return;\n-                }\n-\n-                // 發送 AJAX 請求獲取對應數據\n-                $.ajax({\n-                    url: \"{{ localized_route('admin.get-categories-data') }}\",\n-                    type: 'GET',\n-                    data: {\n-                        application_category_id: applicationCategoryId\n-                    },\n-                    dataType: 'json',\n-                    success: function(response) {\n-                        // 填充產品品牌下拉選單\n-                        if (response.brands && Object.keys(response.brands).length > 0) {\n-                            $.each(response.brands, function(id, name) {\n-                                $('#brands_info_id').append(\n-                                    $('<option></option>').val(id).text(name)\n-                                );\n-                            });\n-\n-                            // 如果是編輯頁面，選中原有的品牌\n-                            if (currentBrandId) {\n-                                $('#brands_info_id').val(currentBrandId);\n-                            }\n-                        }\n-\n-                        // 填充產品類別下拉選單\n-                        if (response.productCategories && Object.keys(response.productCategories).length > 0) {\n-                            $.each(response.productCategories, function(id, name) {\n-                                $('#product_categories_id').append(\n-                                    $('<option></option>').val(id).text(name)\n-                                );\n-                            });\n-\n-                            // 如果是編輯頁面，選中原有的產品類別(使用正確的變數名稱)\n-                            if (currentProductCategoryIds && currentProductCategoryIds.length > 0) {\n-                                $('#product_categories_id').val(currentProductCategoryIds);\n-                                // 觸發change事件以更新Select2顯示\n-                                $('#product_categories_id').trigger('change');\n-                            }\n-                        }\n-                    },\n-                    error: function(xhr, status, error) {\n-                        console.error('獲取數據失敗:', error);\n-                    }\n-                });\n-            });\n-\n-            // 如果是編輯頁面，初始加載相關數據\n-            if ($('#application_categories_info_id').val()) {\n-                $('#application_categories_info_id').trigger('change');\n-            }\n-\n-            // 頁面載入時初始化購買/租賃欄位的狀態\n-            $(document).ready(function() {\n-                // 檢查並設置 purchase_lease 欄位的初始顯示狀態\n-                if ($('#application_categories_info_id').val() == 1) {\n-                    $('#purchase_lease_container').show();\n-                    $('#purchase_lease').prop('required', true);\n-\n-                    // 如果是編輯頁面，設置已保存的值\n-                    @if(isset($productsInfo) && $productsInfo->purchase_lease)\n-                        $('#purchase_lease').val('{{ $productsInfo->purchase_lease }}');\n-                    @endif\n-                } else {\n-                    $('#purchase_lease_container').hide();\n-                    $('#purchase_lease').prop('required', false);\n-                }\n-            });\n-        });\n-    </script>\n-@endpush\n"
                }
            ],
            "date": 1753257400915,
            "name": "Commit-0",
            "content": "<!-- Application Categories Info Id Field -->\n<div class=\"form-group col-sm-6\">\n    {!! Form::label('application_categories_info_id', '應用類別:', ['class' => 'control-label', 'style' => 'font-weight:bold !important;']) !!}\n    {!! Form::select('application_categories_info_id', $applicationCategoriesInfos, isset($productCategoriesInfo) ? $productCategoriesInfo->application_categories_info_id : null, ['class' => 'form-control', 'id' => 'application_categories_info_id', 'placeholder' => '請選擇', 'required' => true]) !!}\n    {{-- <small>※請選擇應用類別</small> --}}\n</div>\n<div class=\"clearfix w-100\"></div>\n\n<!-- Purchase_Lease Field -->\n<div class=\"form-group col-sm-6\" id=\"purchase_lease_container\">\n    {!! Form::label('purchase_lease', '產品購買/租賃:') !!}\n    {!! Form::select('purchase_lease', ['' => '請選擇', 'purchase' => '購買', 'lease' => '租賃'], null, ['class' => 'form-control', 'id' => 'purchase_lease', 'placeholder' => '請選擇產品購買/租賃方式', 'required' => true]) !!}\n</div>\n<div class=\"clearfix w-100\"></div>\n\n<!-- Brands Info Id Field -->\n<div class=\"form-group col-sm-4\">\n    {!! Form::label('brands_info_id', '產品品牌:') !!}\n    {!! Form::select('brands_info_id', [], null, ['class' => 'form-control', 'placeholder' => '請先選擇應用類別', 'id' => 'brands_info_id', 'required' => true]) !!}\n</div>\n\n<!-- Product Categories Id Field -->\n<div class=\"form-group col-sm-4\">\n    {!! Form::label('product_categories_id', '產品類別:') !!}\n    {!! Form::select('product_categories_id', [], null, ['class' => 'form-control', 'placeholder' => '請先選擇應用類別', 'id' => 'product_categories_id', 'multiple', 'required' => true]) !!}\n</div>\n\n<!-- Version Field -->\n<div class=\"form-group col-sm-4\">\n    {!! Form::label('version', '產品型號(機型版本):') !!}\n    {!! Form::text('version', null, ['class' => 'form-control']) !!}\n</div>\n<div class=\"clearfix w-100\"></div>\n\n<!-- 'bootstrap / Toggle Switch Quick Bucket Changer Field' -->\n<div class=\"form-group col-sm-6\">\n    <div class=\"custom-control custom-switch\">\n        {!! Form::checkbox('quick_bucket_changer', 1, null,  ['class' => 'custom-control-input', 'id' => 'quick_bucket_changer']) !!}\n        {!! Form::label('quick_bucket_changer', '快速換斗器', ['class' => 'custom-control-label']) !!}\n    </div>\n</div>\n<div class=\"clearfix w-100\"></div>\n\n<!-- 'bootstrap / Toggle Switch Operating Converter Field' -->\n<div class=\"form-group col-sm-6\">\n    <div class=\"custom-control custom-switch\">\n        {!! Form::checkbox('operating_converter', 1, null,  ['class' => 'custom-control-input', 'id' => 'operating_converter']) !!}\n        {!! Form::label('operating_converter', '操作轉換器', ['class' => 'custom-control-label']) !!}\n    </div>\n</div>\n<div class=\"clearfix w-100\"></div>\n\n<!-- 多語系欄位 -->\n<div class=\"card col-sm-12\">\n    <div class=\"card-header\">\n        <ul class=\"nav nav-tabs card-header-tabs\" role=\"tablist\">\n            @foreach(config('translatable.locales') as $locale)\n                <li class=\"nav-item\">\n                    <a class=\"nav-link {{ $loop->first ? 'active' : '' }}\" data-toggle=\"tab\" href=\"#{{ $locale }}\" role=\"tab\">\n                        {{ strtoupper($locale) === 'ZH_TW' ? '中文' : 'English' }} 語系\n                    </a>\n                </li>\n            @endforeach\n        </ul>\n    </div>\n    <div class=\"card-body\">\n        <div class=\"tab-content\">\n            @foreach(config('translatable.locales') as $locale)\n                <div class=\"tab-pane {{ $loop->first ? 'active' : '' }}\" id=\"{{ $locale }}\" role=\"tabpanel\">\n\n                    <!-- Name Field -->\n                    <div class=\"form-group col-sm-6\">\n                        {!! Form::label($locale.'[name]', '產品名稱('.strtoupper($locale).'):') !!}\n                        {!! Form::text($locale.'[name]', isset($productsInfo) ? $productsInfo->translate($locale)->name : null, ['class' => 'form-control', 'required' => true]) !!}\n                    </div>\n\n                    <!-- Piping Field -->\n                    <div class=\"form-group col-sm-6\">\n                        {!! Form::label($locale.'[piping]', '配管('.strtoupper($locale).'):') !!}\n                        {!! Form::text($locale.'[piping]', isset($productsInfo) ? $productsInfo->translate($locale)->piping : null, ['class' => 'form-control']) !!}\n                    </div>\n\n                    <!-- Glue Block Field -->\n                    <div class=\"form-group col-sm-6\">\n                        {!! Form::label($locale.'[glue_block]', '膠塊('.strtoupper($locale).'):') !!}\n                        {!! Form::text($locale.'[glue_block]', isset($productsInfo) ? $productsInfo->translate($locale)->glue_block : null, ['class' => 'form-control']) !!}\n                    </div>\n\n                    <!-- Introduction Field -->\n                    <div class=\"form-group col-sm-12\">\n                        {!! Form::label($locale.'[introduction]', '產品介紹('.strtoupper($locale).'):') !!}\n                        {!! Form::textarea($locale.'[introduction]', isset($productsInfo) ? $productsInfo->translate($locale)->introduction : null, ['class' => 'form-control tinymce-editor tinymce-editor-introductions']) !!}\n                    </div>\n                </div>\n            @endforeach\n        </div>\n    </div>\n</div>\n\n<!-- Prod Img Cover Field -->\n<div class=\"form-group col-sm-6\">\n    {!! Form::label('prod_img_cover', '產品封面圖片:') !!}\n    {{-- 尺寸說明 --}}\n    <p class=\"text-muted\">建議尺寸: 400x328px</p>\n    <div class=\"custom-file\">\n        <input type=\"file\" class=\"custom-file-input\" id=\"prod_img_cover\" name=\"prod_img_cover\" accept=\"image/*\">\n        <label class=\"custom-file-label prod_img_cover_label\" for=\"prod_img_cover\">選擇產品封面圖片</label>\n    </div>\n    <div class=\"img-preview-prod-img-cover mt-2\">\n        @if (isset($productsInfo) && $productsInfo->prod_img_cover)\n            <p>預覽</p>\n            <img src=\"{{ asset('uploads/' . $productsInfo->prod_img_cover) }}\" style=\"max-width: 200px; max-height: 200px;\">\n        @endif\n    </div>\n</div>\n<div class=\"clearfix w-100\"></div>\n\n<!-- PDF Field -->\n<div class=\"form-group col-sm-6\">\n    {!! Form::label('pdf', '產品PDF檔案:') !!}\n    <div class=\"custom-file\">\n        <input type=\"file\" class=\"custom-file-input\" id=\"pdf\" name=\"pdf\" accept=\".pdf\">\n        <label class=\"custom-file-label pdf_label\" for=\"pdf\">選擇PDF檔案</label>\n    </div>\n    <div class=\"mt-2\">\n        @if (isset($productsInfo) && $productsInfo->pdf)\n            <p>已上傳PDF檔案: <a href=\"{{ asset('uploads/' . $productsInfo->pdf) }}\" target=\"_blank\">{{ basename($productsInfo->pdf) }}</a></p>\n        @else\n            <p>尚未上傳PDF檔案</p>\n        @endif\n    </div>\n</div>\n\n<!-- Product Images Field -->\n<div class=\"form-group col-sm-12\">\n    {!! Form::label('product_images', '產品圖片:') !!}\n    {{-- 尺寸說明 --}}\n    <p class=\"text-muted\">建議尺寸: 1024x648px</p>\n    <div class=\"input-group\">\n        <div class=\"custom-file\">\n            <input type=\"file\" class=\"custom-file-input\" id=\"product_images\" name=\"product_images[]\" multiple\n                accept=\"image/*\">\n            <label class=\"custom-file-label product_images_label\" for=\"product_images\">選擇圖片（可多選）</label>\n        </div>\n    </div>\n    <small class=\"text-muted\">可拖曳圖片進行排序，<span id=\"remaining-count\">剩餘可上傳: 10 張</span>，每個產品最多10張圖片</small>\n</div>\n\n<!-- 圖片預覽與排序區域 -->\n<div class=\"form-group col-sm-12\">\n    <label>圖片預覽與排序</label>\n    <div class=\"row sortable-container\" id=\"image-preview-container\">\n        @if (isset($productsInfo) && $productsInfo->images->count() > 0)\n            @foreach ($productsInfo->images as $image)\n                <div class=\"col-md-3 mb-3 image-item\" data-image-id=\"{{ $image->id }}\">\n                    <div class=\"card\">\n                        <div class=\"card-header2 p-1 bg-light d-flex justify-content-between align-items-center\">\n                            <span class=\"drag-handle\"><i class=\"fas fa-grip-lines\"></i></span>\n                            <button type=\"button\" class=\"btn btn-sm btn-danger delete-image\"><i\n                                    class=\"fas fa-times\"></i></button>\n                        </div>\n                        <img src=\"{{ asset('uploads/' . $image->image_path) }}\" class=\"card-img-top\" alt=\"產品圖片\"\n                            style=\"height: 150px; object-fit: cover;\">\n                        <input type=\"hidden\" name=\"image_ids[]\" value=\"{{ $image->id }}\">\n                    </div>\n                </div>\n            @endforeach\n        @endif\n    </div>\n</div>\n\n@push('third_party_stylesheets')\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css\">\n    <style>\n        .drag-handle {\n            cursor: move;\n        }\n\n        .ui-sortable-helper {\n            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n        }\n\n        .ui-sortable-placeholder {\n            visibility: visible !important;\n            border: 2px dashed #ccc;\n            background-color: #f8f9fa;\n            height: 220px;\n        }\n\n        .opacity-50 {\n            opacity: 0.5;\n        }\n    </style>\n@endpush\n\n@push('third_party_scripts')\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js\"></script>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/axios/0.26.1/axios.min.js\"\n        integrity=\"sha512-bPh3uwgU5qEMipS/VOmRqynnMXGGSRv+72H/N260MQeXZIK4PG48401Bsby9Nq5P5fz7hy5UGNmC/W1Z51h2GQ==\"\n        crossorigin=\"anonymous\" referrerpolicy=\"no-referrer\"></script>\n    {{-- <script src=\"https://cdn.tiny.cloud/1/1ugon3r0i7rnpx6jhdz4moygn9knxfai212wbqlixzr9hpi8/tinymce/6/tinymce.min.js\"\n        referrerpolicy=\"origin\"></script> --}}\n    <script src=\"{!! asset('vendor/tinymce/js/tinymce/tinymce.js') !!}\"></script>\n@endpush\n\n@push('page_scripts')\n    <script src=\"{{ asset('assets/admin/js/products.js') }}\" referrerpolicy=\"no-referrer\"></script>\n    <script>\n        const loadingSwal = Swal.fire({\n            title: '載入中...',\n            text: '請稍候',\n            allowOutsideClick: false,\n            didOpen: () => {\n                Swal.showLoading();\n            }\n        });\n\n        // 頁面完全載入後（包含所有圖片和資源）關閉載入動畫\n        $(window).on('load', function() {\n            loadingSwal.close();\n        });\n\n        // 也可以設定一個逾時機制，避免載入過久\n        setTimeout(function() {\n            loadingSwal.close();\n        }, 5000); // 5秒後自動關閉\n\n        $(function() {\n\n            // prod_img_cover 檔案選擇器\n            $('#prod_img_cover').on('change', function() {\n                // 檢查是否選擇了檔案\n                if (this.files.length === 0) {\n                    // 如果沒有選擇檔案，清除預覽區域\n                    $(this).closest('.form-group').find('.img-preview-prod-img-cover').html('');\n                    $('.prod_img_cover_label').text('選擇產品封面圖片');\n                    return;\n                }\n                let fileInput = this;\n                let fileReader = new FileReader();\n\n                fileReader.onload = function(e) {\n                    let previewHtml = `<p for=\"\">預覽</p><img src=\"${e.target.result}\" style=\"max-width: 200px; max-height: 200px;\">`;\n                    $(fileInput).closest('.form-group').find('.img-preview-prod-img-cover').html(previewHtml);\n                };\n\n                fileReader.readAsDataURL(fileInput.files[0]);\n\n                // 更新標籤顯示\n                const coverFileName = this.files.length > 0 ? this.files[0].name : '選擇產品封面圖片';\n                $('.prod_img_cover_label').text(coverFileName);\n            });\n\n            // pdf 檔案選擇器\n            $('#pdf').on('change', function() {\n                // 更新標籤顯示\n                const pdfFileName = this.files.length > 0 ? this.files[0].name : '選擇PDF檔案';\n                $('.pdf_label').text(pdfFileName);\n            });\n\n\n            // 用於追蹤目前選擇的檔案\n            let selectedFiles = [];\n            let fileIndices = {};\n\n            // 圖片數量限制\n            const MAX_IMAGES = 10;\n\n            // 顯示檔案名稱\n            $('#product_images').on('change', function() {\n                const inputFiles = Array.from(this.files);\n\n                // 檢查總圖片數量是否會超過限制\n                const existingImageCount = $('.image-item').not('.new-image').not('.opacity-50').length;\n                const totalImagesAfterUpload = existingImageCount + inputFiles.length;\n\n                if (totalImagesAfterUpload > MAX_IMAGES) {\n                    alert(`每個產品最多只能有 ${MAX_IMAGES} 張圖片。目前已有 ${existingImageCount} 張，您選擇了 ${inputFiles.length} 張。`);\n                    resetFileInput();\n                    return;\n                }\n\n                // 儲存選擇的檔案\n                selectedFiles = inputFiles;\n\n                // 更新顯示的檔案名稱\n                updateFileLabel();\n\n                // 清除之前的新圖片預覽\n                $('.new-image').remove();\n\n                // 預覽新上傳的圖片\n                selectedFiles.forEach((file, index) => {\n                    fileIndices[index] = index; // 追蹤原始索引\n                    const reader = new FileReader();\n\n                    reader.onload = function(e) {\n                        // 建立新圖片預覽區塊\n                        const imageItemHtml = `\n                        <div class=\"col-md-3 mb-3 image-item new-image\" data-file-index=\"${index}\">\n                            <div class=\"card\">\n                                <div class=\"card-header2 p-1 bg-light d-flex justify-content-between align-items-center\">\n                                    <span class=\"drag-handle\"><i class=\"fas fa-grip-lines\"></i></span>\n                                    <button type=\"button\" class=\"btn btn-sm btn-danger delete-new-image\"><i class=\"fas fa-times\"></i></button>\n                                </div>\n                                <img src=\"${e.target.result}\" class=\"card-img-top\" alt=\"新圖片預覽\" style=\"height: 150px; object-fit: cover;\">\n                                <div class=\"card-footer p-1 text-center\">\n                                    <small class=\"text-muted\">${file.name}</small>\n                                </div>\n                                <input type=\"hidden\" name=\"new_images[]\" value=\"${index}\">\n                            </div>\n                        </div>\n                    `;\n\n                        $('#image-preview-container').append(imageItemHtml);\n\n                        // 重新初始化排序功能\n                        initSortable();\n                    };\n\n                    reader.readAsDataURL(file);\n                });\n            });\n\n            // 更新檔案標籤顯示\n            function updateFileLabel() {\n                const fileNames = selectedFiles.map(file => file.name);\n                if (fileNames.length > 0) {\n                    $('.product_images_label').html(fileNames.join(', '));\n                } else {\n                    $('.product_images_label').html('選擇圖片（可多選）');\n                }\n            }\n\n            // 在產品圖片區域顯示剩餘可上傳數量\n            function updateRemainingCount() {\n                const existingImageCount = $('.image-item').not('.opacity-50').length;\n                const remainingCount = MAX_IMAGES - existingImageCount;\n\n                $('#remaining-count').text(`剩餘可上傳: ${remainingCount} 張`);\n\n                // 如果已達上限，禁用上傳按鈕\n                if (remainingCount <= 0) {\n                    $('#product_images').prop('disabled', true);\n                    $('.product_images_label').text('已達上傳上限');\n                } else {\n                    $('#product_images').prop('disabled', false);\n                }\n            }\n\n            // 初始更新剩餘數量\n            updateRemainingCount();\n\n            // 初始化拖曳排序\n            function initSortable() {\n                $('.sortable-container').sortable({\n                    items: '.image-item',\n                    handle: '.drag-handle',\n                    cursor: 'move',\n                    placeholder: 'col-md-3 mb-3 ui-sortable-placeholder',\n                    update: function(event, ui) {\n                        // 更新排序順序（將在表單提交時處理）\n                    }\n                }).disableSelection();\n            }\n\n            // 初始化排序功能\n            initSortable();\n\n            // 刪除現有圖片\n            $(document).on('click', '.delete-image', function() {\n                const imageItem = $(this).closest('.image-item');\n                const imageId = imageItem.data('image-id');\n\n                // 添加一個隱藏欄位，標記要刪除的圖片\n                $('<input>').attr({\n                    type: 'hidden',\n                    name: 'delete_images[]',\n                    value: imageId\n                }).appendTo('form');\n\n                // 視覺上標記為刪除，而不是完全移除\n                imageItem.addClass('opacity-50');\n                $(this).removeClass('btn-danger').addClass('btn-success').html(\n                    '<i class=\"fas fa-undo\"></i>');\n                $(this).removeClass('delete-image').addClass('restore-image');\n\n                // 更新剩餘可上傳數量\n                updateRemainingCount();\n            });\n\n            // 復原刪除現有圖片\n            $(document).on('click', '.restore-image', function() {\n                const imageItem = $(this).closest('.image-item');\n                const imageId = imageItem.data('image-id');\n\n                // 移除標記刪除的隱藏欄位\n                $('input[name=\"delete_images[]\"][value=\"' + imageId + '\"]').remove();\n\n                // 視覺上恢復正常\n                imageItem.removeClass('opacity-50');\n                $(this).removeClass('btn-success').addClass('btn-danger').html(\n                    '<i class=\"fas fa-times\"></i>');\n                $(this).removeClass('restore-image').addClass('delete-image');\n\n                // 更新剩餘可上傳數量\n                updateRemainingCount();\n            });\n\n            // 刪除新上傳的圖片預覽\n            $(document).on('click', '.delete-new-image', function() {\n                const imageItem = $(this).closest('.image-item');\n                const fileIndex = imageItem.data('file-index');\n\n                // 從選取的檔案陣列中移除此檔案\n                if (fileIndex !== undefined) {\n                    // 移除檔案\n                    selectedFiles = selectedFiles.filter((_, index) => index !== fileIndex);\n\n                    // 更新檔案索引映射\n                    const newFileIndices = {};\n                    let newIndex = 0;\n\n                    for (let i = 0; i < selectedFiles.length; i++) {\n                        if (i !== fileIndex) {\n                            newFileIndices[newIndex] = i;\n                            newIndex++;\n                        }\n                    }\n\n                    fileIndices = newFileIndices;\n\n                    // 更新顯示標籤\n                    updateFileLabel();\n                }\n\n                // 移除預覽\n                imageItem.remove();\n\n                // 檢查是否還有新圖片預覽，如果沒有則重置檔案選擇器\n                if ($('.new-image').length === 0) {\n                    resetFileInput();\n                }\n\n                // 更新剩餘可上傳數量\n                updateRemainingCount();\n            });\n\n            // 重置檔案選擇器\n            function resetFileInput() {\n                // 清空檔案選擇器的值\n                $('#product_images').val('');\n\n                // 清空選取的檔案陣列\n                selectedFiles = [];\n                fileIndices = {};\n\n                // 重置標籤文字\n                $('.product_images_label').html('選擇圖片（可多選）');\n            }\n\n            // 表單提交前處理\n            $('form').on('submit', function() {\n                // 檢查總圖片數量是否超過限制\n                const visibleImageCount = $('.image-item').not('.opacity-50').length;\n                const newImageCount = $('.new-image').length;\n\n                // 計算實際有效圖片數（現有未刪除 + 新上傳）\n                const activeImageCount = visibleImageCount - newImageCount + selectedFiles.length;\n\n                if (activeImageCount > MAX_IMAGES) {\n                    alert(`每個產品最多只能有 ${MAX_IMAGES} 張圖片，請刪除部分圖片後再提交。`);\n                    return false;\n                }\n\n                // 處理混合排序情況\n                let sortOrder = 0;\n\n                // 取得所有圖片元素（包括現有和新上傳的）\n                $('.sortable-container .image-item').not('.opacity-50').each(function() {\n                    // 檢查是否為現有圖片\n                    const imageId = $(this).data('image-id');\n                    if (imageId) {\n                        // 更新現有圖片的排序值\n                        $(this).find('input[name=\"image_ids[]\"]').val(imageId);\n                        $(this).append('<input type=\"hidden\" name=\"sort_orders[' + imageId +\n                            ']\" value=\"' + sortOrder + '\">');\n                    }\n\n                    // 檢查是否為新上傳圖片\n                    const fileIndex = $(this).data('file-index');\n                    if (fileIndex !== undefined) {\n                        // 確保新圖片的排序值正確\n                        $(this).find('input[name=\"new_images[]\"]').val(fileIndex);\n                        $(this).append('<input type=\"hidden\" name=\"new_sort_orders[]\" value=\"' +\n                            sortOrder + '\">');\n                    }\n\n                    sortOrder++;\n                });\n\n                return true;\n            });\n\n\n\n            // 儲存當前產品的品牌和產品類別ID (如果是編輯頁面)\n            var currentBrandId = {{ isset($productsInfo) && $productsInfo->brands_info_id ? $productsInfo->brands_info_id : 'null' }};\n            var currentProductCategoryId = {{ isset($productsInfo) && $productsInfo->product_categories_id ? $productsInfo->product_categories_id : 'null' }};\n            $('#purchase_lease_container').hide();\n            // 應用類別選擇變更事件\n            $('#application_categories_info_id').on('change', function() {\n                var applicationCategoryId = $(this).val();\n\n                // 控制 purchase_lease 欄位顯示和必填狀態\n                if (applicationCategoryId == 1) { // 1為建設機械\n                    $('#purchase_lease_container').show();\n                    $('#purchase_lease').prop('required', true);\n                } else {\n                    $('#purchase_lease_container').hide();\n                    $('#purchase_lease').prop('required', false);\n                    $('#purchase_lease').val(''); // 清空選擇的值\n                }\n\n                // 清空產品品牌和產品類別下拉選單\n                $('#brands_info_id').empty().append('<option value=\"\">請選擇</option>');\n                $('#product_categories_id').empty().append('<option value=\"\">請選擇</option>');\n\n                if (!applicationCategoryId) {\n                    return;\n                }\n\n                // 發送 AJAX 請求獲取對應數據\n                $.ajax({\n                    url: \"{{ localized_route('admin.get-categories-data') }}\",\n                    type: 'GET',\n                    data: {\n                        application_category_id: applicationCategoryId\n                    },\n                    dataType: 'json',\n                    success: function(response) {\n                        // 填充產品品牌下拉選單\n                        if (response.brands && Object.keys(response.brands).length > 0) {\n                            $.each(response.brands, function(id, name) {\n                                $('#brands_info_id').append(\n                                    $('<option></option>').val(id).text(name)\n                                );\n                            });\n\n                            // 如果是編輯頁面，選中原有的品牌\n                            if (currentBrandId) {\n                                $('#brands_info_id').val(currentBrandId);\n                            }\n                        }\n\n                        // 填充產品類別下拉選單\n                        if (response.productCategories && Object.keys(response.productCategories).length > 0) {\n                            $.each(response.productCategories, function(id, name) {\n                                $('#product_categories_id').append(\n                                    $('<option></option>').val(id).text(name)\n                                );\n                            });\n\n                            // 如果是編輯頁面，選中原有的產品類別\n                            if (currentProductCategoryId) {\n                                $('#product_categories_id').val(currentProductCategoryId);\n                            }\n                        }\n                    },\n                    error: function(xhr, status, error) {\n                        console.error('獲取數據失敗:', error);\n                    }\n                });\n            });\n\n            // 如果是編輯頁面，初始加載相關數據\n            if ($('#application_categories_info_id').val()) {\n                $('#application_categories_info_id').trigger('change');\n            }\n\n            // 頁面載入時初始化購買/租賃欄位的狀態\n            $(document).ready(function() {\n                // 檢查並設置 purchase_lease 欄位的初始顯示狀態\n                if ($('#application_categories_info_id').val() == 1) {\n                    $('#purchase_lease_container').show();\n                    $('#purchase_lease').prop('required', true);\n\n                    // 如果是編輯頁面，設置已保存的值\n                    @if(isset($productsInfo) && $productsInfo->purchase_lease)\n                        $('#purchase_lease').val('{{ $productsInfo->purchase_lease }}');\n                    @endif\n                } else {\n                    $('#purchase_lease_container').hide();\n                    $('#purchase_lease').prop('required', false);\n                }\n            });\n        });\n    </script>\n@endpush\n"
        }
    ]
}